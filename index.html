<!--
    Autor: Mario Pérez Esteso <mario@geekytheory.com>
    Web: geekytheory.com
-->
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
    Raspberry Pi Status
  </title>
  <!-- Importo el módulo socket.io que tengo en el proyecto -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery.min.js"></script>
  <!-- Importo el archivo Javascript de Highcharts directamente desde su servidor -->
  <!--<script src="http://code.highcharts.com/highcharts.js" type="application/javascript"></script>-->
  <script src="http://code.highcharts.com/stock/highstock.js"></script>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">

  <!-- Optional theme -->
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap-theme.min.css">

  <!-- Latest compiled and minified JavaScript -->
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>
  <script src="http://code.highcharts.com/modules/exporting.js"></script>

</head>
<body>
  <!-- Main jumbotron for a primary marketing message or call to action -->
  <div class="container">

  <nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">
          <img
            src="http://elinux.org/images/thumb/c/cb/Raspberry_Pi_Logo.svg/100px-Raspberry_Pi_Logo.svg.png"
            style="height:20px" />
        </a>
      </div>

      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
          <li>
            <a>
              <span id="p_hostname">Here you can see the general info of the Raspberry Pi</span>
            </a>
          </li>
          <li>
            <a>
              <span id="p_kernel"></span>
            </a>
          </li>
          <li>
            <a>
              <span id="p_uptime"></span>
            </a>
          </li>
        </ul>
      </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
  </nav>

  <div class="row">
    <div class="col-lg-4">
      <div class="panel panel-primary">
        <div class="panel-heading">Top list</div>
        <div class="panel-body">
          <div>
            <ol id="toplist">
            </ol>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-8">
      <div id="chartMemory" style="min-width: 100; height:250px; margin: 0 auto"></div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6">
      <div class="container" id="chart" style="width:100%; height:300px;"></div>
    </div>
    <div class="col-lg-6">
      <div class="container" id="cpu_usage" style="width:100%; height:300px;"></div>
    </div>
  </div>
  </div>
  <!-- Creo el div donde tendré la gráfica. Le digo que ocupe todo el ancho
       de la pantalla y 400px de alto -->

  <!-- Comienza el Javascript -->
  <script>
  function prettyUptime(time) {
    // Minutes and seconds
    var mins = ~~(time / 60);
    var secs = time % 60;

    // Hours, minutes and seconds
    var hrs = ~~(time / 3600);
    var mins = ~~((time % 3600) / 60);
    var secs = Math.round(time % 60);

    // Output like "1:01" or "4:03:59" or "123:03:59"
    ret = "";

    if (hrs > 0)
        ret += "" + hrs + ":" + (mins < 10 ? "0" : "");

    ret += "" + mins + ":" + (secs < 10 ? "0" : "");
    ret += "" + secs;
    return ret;
  }
  // Creo un WebSocket. ¡Poned la IP de vuestra Raspberry Pi!
  var socket = io.connect('http://'+ location.host);
  // console.log(location.host)
  // Creo un nuevo objeto 'Chart'
  var chart, chartCPU, chartMem, memTotal;
  chart = new Highcharts.StockChart({
    chart: {
      renderTo: 'chart',
      defaultSeriesType: 'spline'
    },
    rangeSelector : {
      selected : 100
    },
    title: {
      text: 'CPU Temperature Raspberry Pi'
    },
    xAxis: {
      type: 'datetime',
      tickPixelInterval: 150,
      maxZoom: 20 * 1000
    },
    yAxis: {
      minPadding: 0.2,
      maxPadding: 0.2,
      title: {
        text: 'Temperature ºC',
        margin: 10
      }
    },
    series: [{
      name: 'Temperature',
      data: []
    }],
    credits: {
      enabled: false
    }
  });

  chartCPU = new Highcharts.StockChart({
    chart: {
      renderTo: 'cpu_usage',
      defaultSeriesType: 'spline'
    },
    rangeSelector : {
      selected : 100
    },
    title: {
      text: 'CPU Load Raspberry Pi'
    },
    xAxis: {
      type: 'datetime',
      tickPixelInterval: 150,
      maxZoom: 20 * 1000
    },
    yAxis: {
      minPadding: 0.2,
      maxPadding: 0.2,
      title: {
        text: 'CPU Load (%)',
        margin: 10
      }
    },
    series: [{
      name: 'CPU Load',
      data: []
    }],
    credits: {
      enabled: false
    }
  });

  chartMem = new Highcharts.Chart({
    chart: {
      renderTo: 'chartMemory',
      type: 'bar'
    },
    title: {
      text: 'Memory'
    },
    xAxis: {
      categories: ['Used', 'Free', 'Buffered', 'Cached'],
      title: {
          text: null
      }
    },
    yAxis: {
      min: 0,
      title: {
        text: "Percentage",
        align: 'high'
      },
      labels: {
        overflow: 'justify'
      }
    },
    tooltip: {
      valueSuffix: ' %'
    },
    plotOptions: {
      bar: {
        dataLabels: {
          enabled: true
        }
      }
    },
    credits: {
      enabled: false
    },
    series: [{
      name: "Memory",
      data: [{y: 0, color: 'red'}, {y: 0, color: 'green'}, {y: 0, color: 'blue'}, {y: 0, color: 'orange'}]
    }]
  });

  var updateToplist = function (toplist) {
    var res = toplist.split("\n");
    var result = "";
    for (r in res) {
      if (res[r] != "") {
        result = result + "<li>" + res[r] + "</li>"
      }
    }
    document.getElementById("toplist").innerHTML=result;
  };

  var updateCpuUsage = function (time, d) {
    var series = chartCPU.series[0];
    series.addPoint([time, d]);
  };

  var updateMemory = function (free, used, buffered, cached) {
    chartMem.series[0].setData([{y: used, color: 'red'}, {y: free, color: 'green'}, {y: buffered, color: 'blue'}, {y: cached, color: 'orange'}]);
  };

  var updateTemp =function (time, d) {
    var series = chart.series[0];
    series.addPoint([time, d]);
  };

  socket.on('collected', function(data){
    updateToplist(data.toplist);
    updateCpuUsage(data.date,data.cpuusage);
    document.getElementById("p_hostname").innerHTML="<b>Hostname:</b> "+data.hostname;
    document.getElementById("p_kernel").innerHTML="<b>Kernel:</b> "+data.kernel;
    document.getElementById("p_uptime").innerHTML="<b>Up time:</b> "+ prettyUptime(data.uptime);
    chartMem.setTitle({text:"Memory: "+data.memtotal+" KB"});
    var memUsed = data.memtotal-data.memfree;
    var percentUsed = Math.round(memUsed*100/data.memtotal);
    var percentFree = 100 - percentUsed;
    var percentBuffered = Math.round(data.membuffers*100/data.memtotal);
    var percentCached = Math.round(data.memcached*100/data.memtotal);
    updateMemory(percentFree,percentUsed,percentBuffered,percentCached)
    updateTemp(data.date,data.temp);
  });
  </script>
</body>
</html>